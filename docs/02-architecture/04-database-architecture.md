# Database Architecture

Database schema, adapters, and data model.

## Overview

**Default Database:** Supabase (managed PostgreSQL)

**Schema Location:** `supabase/migrations/`

**Adapter Pattern:** Multiple database adapters supported

**Source:** Database configuration in `server/config/deployment.ts` line 25.

## Database Schema

### Core Tables

**Users Table (`users`):**
- `id` (UUID, primary key)
- `email` (text, unique)
- `full_name` (text)
- `role` (text: 'admin' | 'customer')
- `created_at` (timestamp)
- `updated_at` (timestamp)

**Source:** Users schema in `supabase/migrations/00000000000002_base_schema.sql` lines 7-16.

**Products Table (`products`):**
- `id` (UUID, primary key)
- `name` (text)
- `description` (text)
- `price` (integer, in cents)
- `category` (text)
- `stock_quantity` (integer)
- `sku` (text, unique)
- `created_at` (timestamp)
- `updated_at` (timestamp)

**Source:** Products schema in `supabase/migrations/00000000000002_base_schema.sql` lines 18-29.

**Orders Table (`orders`):**
- `id` (UUID, primary key)
- `user_id` (UUID, foreign key to users)
- `status` (text: 'pending' | 'processing' | 'shipped' | 'delivered' | 'cancelled')
- `total_amount` (integer, in cents)
- `shipping_address` (text)
- `created_at` (timestamp)
- `updated_at` (timestamp)

**Source:** Orders schema in `supabase/migrations/00000000000002_base_schema.sql` lines 31-42.

**Order Items Table (`order_items`):**
- `id` (UUID, primary key)
- `order_id` (UUID, foreign key to orders)
- `product_id` (UUID, foreign key to products)
- `quantity` (integer)
- `unit_price` (integer, in cents)
- `created_at` (timestamp)

**Source:** Order items schema in `supabase/migrations/00000000000002_base_schema.sql` lines 44-52.

**Payments Table (`payments`):**
- `id` (UUID, primary key)
- `order_id` (UUID, foreign key to orders)
- `amount` (integer, in cents)
- `status` (text: 'pending' | 'processing' | 'completed' | 'failed')
- `payment_method` (text)
- `transaction_id` (text)
- `created_at` (timestamp)
- `updated_at` (timestamp)

**Source:** Payments schema in `supabase/migrations/00000000000002_base_schema.sql` lines 54-65.

**Inventory Logs Table (`inventory_logs`):**
- `id` (UUID, primary key)
- `product_id` (UUID, foreign key to products)
- `change_type` (text: 'sale' | 'restock' | 'adjustment')
- `quantity_change` (integer)
- `previous_quantity` (integer)
- `new_quantity` (integer)
- `created_at` (timestamp)

**Source:** Inventory logs schema in `supabase/migrations/00000000000002_base_schema.sql` lines 67-78.

## Relationships

### Foreign Key Constraints

**Orders → Users:**
- `orders.user_id` → `users.id`

**Order Items → Orders:**
- `order_items.order_id` → `orders.id`

**Order Items → Products:**
- `order_items.product_id` → `products.id`

**Payments → Orders:**
- `payments.order_id` → `orders.id`

**Inventory Logs → Products:**
- `inventory_logs.product_id` → `products.id`

**Source:** Foreign key constraints in `supabase/migrations/00000000000002_base_schema.sql` lines 80-95.

## Row Level Security (RLS)

### RLS Status

**Enabled:** All tables have RLS enabled

**Source:** RLS enablement in `supabase/migrations/00000000000002_base_schema.sql` lines 144-149.

### RLS Policies

**Development Policies:**
- Products: Public read access
- Users: Full access for authenticated users
- Orders: Full access for authenticated users
- Order Items: Full access for authenticated users
- Payments: Full access for authenticated users
- Inventory Logs: Read-only for authenticated users

**Source:** RLS policies in `supabase/migrations/00000000000004_set_permissions.sql`.

**⚠️ Production Note:** Review and restrict RLS policies for production use

## Database Adapters

### Supabase Adapter

**File:** `server/adapters/database/supabase.ts`

**Default:** Yes

**Features:**
- Full CRUD operations
- Query builder interface
- RLS support
- Automatic connection management

**Source:** Supabase adapter in `server/adapters/database/supabase.ts`.

### PostgreSQL Adapter

**File:** `server/adapters/database/postgresql.ts`

**Status:** Partially implemented

**Configuration:**
- `POSTGRES_HOST`
- `POSTGRES_PORT`
- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `POSTGRES_SSL`

**Source:** PostgreSQL adapter in `server/adapters/database/postgresql.ts`.

### OCI Autonomous Adapter

**File:** `server/adapters/database/oci-autonomous.ts`

**Purpose:** Oracle Cloud Infrastructure Autonomous Database

**Source:** OCI adapter file exists in `server/adapters/database/` directory.

## Data Types

### UUID Primary Keys

**All tables use UUID primary keys:**
- Generated by database (default)
- Type: `uuid`

**Source:** Primary key definitions in schema migration.

### Timestamps

**Automatic Timestamps:**
- `created_at` - Set on insert
- `updated_at` - Updated via trigger

**Source:** Timestamp columns and triggers in schema migration.

### Price Storage

**Format:** Integer (stored in cents)

**Example:** $49.99 stored as 4999

**Source:** Price columns in products, orders, order_items, payments tables.

## Indexes

### Unique Indexes

**Users:**
- `email` (unique)

**Products:**
- `sku` (unique)

**Source:** Unique constraints in schema migration.

### Foreign Key Indexes

**Automatic:** Foreign key columns are indexed

**Source:** Foreign key constraints create indexes automatically.

## Migrations

### Migration Files

**Location:** `supabase/migrations/`

**Files:**
- `00000000000002_base_schema.sql` - Base schema
- `00000000000004_set_permissions.sql` - RLS policies

**Source:** Migration files in `supabase/migrations/` directory.

## Training vs Production

### Training Mode

**Database:** Supabase (managed, easy setup)

**RLS:** Development policies (relaxed)

**Use Case:** Learning, development

### Production Mode

**Database:** Supabase, PostgreSQL, or OCI Autonomous

**RLS:** Production policies (restricted)

**Use Case:** Production deployment

**Source:** Database selection via `DATABASE_TYPE` environment variable.

## Next Steps

- [System Architecture](01-system-architecture.md) - Overall system architecture
- [Database Adapters](../04-configuration/02-database-adapters.md) - Adapter configuration
- [Security: RLS Policies](../12-security/04-rls-policies.md) - Row Level Security

