# ============================================================================
# WORKERS VARIATION - BULL + REDIS
# ============================================================================
# Perfect for: Production background job processing
# Features: Job retries, scheduling, priorities, rate limiting
#
# Advantages:
#   ✅ Reliable job processing with retries
#   ✅ Job scheduling (delayed jobs)
#   ✅ Priority queues
#   ✅ Rate limiting
#   ✅ Job progress tracking
#   ✅ Dashboard UI available (bull-board)
#
# Use Cases:
#   - Email sending (retry on SMTP failures)
#   - Order processing (ensure no order is missed)
#   - Payment processing (with retries and logging)
#   - Data exports (long-running jobs)
#   - Scheduled tasks (daily reports, cleanups)
# ============================================================================

DEPLOYMENT_MODE=single-vm
NODE_ENV=production

# Database (any type works with Bull)
DATABASE_TYPE=supabase
SUPABASE_URL=<REPLACE_THIS>
SUPABASE_ANON_KEY=<REPLACE_THIS>

# Workers - Bull Queue with Redis
WORKER_MODE=bull-queue

# Redis Configuration
QUEUE_REDIS_URL=redis://localhost:6379
QUEUE_PREFIX=bharatmart:queue

# Or separate Redis parameters
# QUEUE_REDIS_HOST=localhost
# QUEUE_REDIS_PORT=6379
# QUEUE_REDIS_PASSWORD=<REPLACE_IF_AUTH_ENABLED>
# QUEUE_REDIS_DB=0

# Worker Configuration
WORKER_CONCURRENCY=5              # Jobs processed in parallel per worker
WORKER_LOCK_DURATION=30000        # Job lock duration (30s)
WORKER_STALLED_INTERVAL=30000     # Check for stalled jobs every 30s

# Job Configuration
QUEUE_ATTEMPTS=3                  # Retry failed jobs 3 times
QUEUE_BACKOFF_DELAY=5000          # Wait 5s before retry
QUEUE_BACKOFF_TYPE=exponential    # exponential or fixed
QUEUE_REMOVE_ON_COMPLETE=100      # Keep last 100 completed jobs
QUEUE_REMOVE_ON_FAIL=1000         # Keep last 1000 failed jobs

# Job Priorities (lower = higher priority)
QUEUE_PRIORITY_HIGH=1
QUEUE_PRIORITY_NORMAL=5
QUEUE_PRIORITY_LOW=10

# Rate Limiting
QUEUE_RATE_LIMITER_MAX=100        # Max 100 jobs
QUEUE_RATE_LIMITER_DURATION=60000 # Per 60 seconds

# Separate Worker Types
# Run different worker processes for each job type:
# pm2 start server/workers/index.js --name email-worker -- --type=email
# pm2 start server/workers/index.js --name order-worker -- --type=order
# pm2 start server/workers/index.js --name payment-worker -- --type=payment

WORKER_TYPE=all  # all, email, order, or payment

# Email Worker Configuration
EMAIL_WORKER_CONCURRENCY=10
EMAIL_WORKER_ATTEMPTS=5
EMAIL_RATE_LIMIT=50               # Max 50 emails per minute

# Order Worker Configuration
ORDER_WORKER_CONCURRENCY=5
ORDER_WORKER_ATTEMPTS=3
ORDER_PROCESSING_TIMEOUT=60000    # 60 seconds

# Payment Worker Configuration
PAYMENT_WORKER_CONCURRENCY=3
PAYMENT_WORKER_ATTEMPTS=3
PAYMENT_PROCESSING_TIMEOUT=30000  # 30 seconds

# Bull Board (Job Dashboard UI)
ENABLE_BULL_BOARD=true
BULL_BOARD_PATH=/admin/queues
BULL_BOARD_USERNAME=admin
BULL_BOARD_PASSWORD=<REPLACE_THIS>

# Server Configuration
PORT=3000
HOST=0.0.0.0
FRONTEND_URL=https://yourdomain.com
CORS_ORIGIN=https://yourdomain.com

# Authentication
AUTH_PROVIDER=supabase
JWT_SECRET=<REPLACE_WITH_SECURE_RANDOM_64_CHAR_STRING>
SUPABASE_SERVICE_ROLE_KEY=<REPLACE_THIS>

# Logging
LOG_LEVEL=info
LOG_FORMAT=json
LOG_FILE=/var/log/bharatmart/api.log

# Metrics
ENABLE_METRICS=true
METRICS_PORT=9090

# Observability
OTEL_SERVICE_NAME=bharatmart-backend
OTEL_EXPORTER_OTLP_ENDPOINT=<OPTIONAL_OTLP_ENDPOINT>
OTEL_TRACES_SAMPLER=always_on

# Chaos Engineering (optional)
CHAOS_ENABLED=false
CHAOS_LATENCY_MS=0

# Frontend Configuration
VITE_API_URL=https://api.yourdomain.com
VITE_APP_NAME=BharatMart
VITE_SUPABASE_URL=<REPLACE_THIS>
VITE_SUPABASE_ANON_KEY=<REPLACE_THIS>

# Admin Seed (for db:init script)
ADMIN_EMAIL=admin@bharatmart.com
ADMIN_PASSWORD=<REPLACE_THIS>

# Redis Setup:
#
# 1. Install Redis:
#    Ubuntu: sudo apt install redis-server
#    Mac: brew install redis
#
# 2. Start Redis:
#    sudo systemctl start redis
#
# 3. Verify:
#    redis-cli PING
#    Should return: PONG
#
# 4. Production: Enable password auth
#    Edit /etc/redis/redis.conf
#    requirepass your_secure_password
#    sudo systemctl restart redis
