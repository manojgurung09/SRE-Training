# ============================================================================
# SINGLE VM - LOCAL STACK (Zero External Dependencies)
# ============================================================================
# Perfect for: Self-hosted production, air-gapped deployments, full control
# Setup time: 2 hours
# Monthly cost: $20-100 (just VM cost)
# Handles: 1,000-10,000 users
# Architecture: All services on one VM (PostgreSQL + Redis + App)
#
# Advantages:
#   ✅ No external service dependencies
#   ✅ Works offline / air-gapped
#   ✅ Full control over data
#   ✅ Lower latency (all local)
#   ✅ Predictable costs
#   ✅ GDPR/privacy friendly
#
# Prerequisites:
#   - Ubuntu 22.04 VM with 8GB RAM, 4 vCPUs
#   - 50GB+ storage
#   - Domain with SSL certificate
#
# Setup Steps:
#   1. Install PostgreSQL: sudo apt install postgresql
#   2. Install Redis: sudo apt install redis-server
#   3. Create database and user
#   4. Copy this config and adjust
#   5. Deploy application
#
# Guide: DEPLOYMENT_QUICKSTART.md#scenario-2-single-vm-production
# ============================================================================

# Deployment Configuration
DEPLOYMENT_MODE=single-vm
NODE_ENV=production

# Database - Local PostgreSQL
DATABASE_TYPE=postgresql
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=bharatmart
DATABASE_USER=bharatmart_user
DATABASE_PASSWORD=<REPLACE_WITH_SECURE_PASSWORD>
DATABASE_POOL_MIN=5
DATABASE_POOL_MAX=15
DATABASE_SSL=false  # Local connection, no SSL needed

# Authentication - Local JWT
AUTH_PROVIDER=local
JWT_SECRET=<REPLACE_WITH_SECURE_RANDOM_64_CHAR_STRING>
JWT_EXPIRY=1h
JWT_REFRESH_EXPIRY=7d

# Workers - Bull Queue with Local Redis
WORKER_MODE=bull-queue
WORKER_CONCURRENCY=5
QUEUE_REDIS_URL=redis://localhost:6379
QUEUE_PREFIX=bharatmart:queue
QUEUE_ATTEMPTS=3
QUEUE_BACKOFF_DELAY=5000

# Cache - Local Redis
CACHE_TYPE=redis
CACHE_REDIS_URL=redis://localhost:6379
CACHE_TTL=600
CACHE_PREFIX=bharatmart:cache

# Secrets Management
SECRETS_PROVIDER=env

# Server Configuration
PORT=3000
HOST=0.0.0.0
FRONTEND_URL=https://yourdomain.com

# Security
CORS_ORIGIN=https://yourdomain.com
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Logging
LOG_LEVEL=info
LOG_FORMAT=json
LOG_FILE=/var/log/bharatmart/api.log

# Metrics
ENABLE_METRICS=true
METRICS_PORT=9090

# Frontend Configuration
VITE_API_URL=https://yourdomain.com
VITE_APP_NAME=BharatMart
VITE_SUPABASE_URL=
VITE_SUPABASE_ANON_KEY=

# Observability
OTEL_SERVICE_NAME=bharatmart-backend
OTEL_EXPORTER_OTLP_ENDPOINT=<OPTIONAL_OTLP_ENDPOINT>
OTEL_TRACES_SAMPLER=always_on

# Chaos Engineering (optional for production)
CHAOS_ENABLED=false
CHAOS_LATENCY_MS=0

# Admin Seed (for db:init script)
ADMIN_EMAIL=admin@bharatmart.com
ADMIN_PASSWORD=<REPLACE_THIS>

# Email Configuration - Local SMTP (optional)
SMTP_HOST=localhost
SMTP_PORT=25
EMAIL_FROM=noreply@yourdomain.com

# Or use external SMTP
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=<REPLACE_THIS>
# SMTP_PASSWORD=<REPLACE_THIS>

# Backup Configuration
BACKUP_ENABLED=true
BACKUP_SCHEDULE=0 2 * * *  # Daily at 2 AM
BACKUP_RETENTION_DAYS=30
BACKUP_PATH=/var/backups/bharatmart
POSTGRES_BACKUP_PATH=/var/backups/bharatmart/postgres
REDIS_BACKUP_PATH=/var/backups/bharatmart/redis

# Complete Setup Script:
# ----------------------
#
# #!/bin/bash
#
# # 1. Update system
# sudo apt update && sudo apt upgrade -y
#
# # 2. Install PostgreSQL
# sudo apt install -y postgresql postgresql-contrib
# sudo systemctl start postgresql
# sudo systemctl enable postgresql
#
# # 3. Create database and user
# sudo -u postgres psql << EOF
# CREATE DATABASE bharatmart;
# CREATE USER bharatmart_user WITH PASSWORD 'secure_password_here';
# GRANT ALL PRIVILEGES ON DATABASE bharatmart TO bharatmart_user;
# \q
# EOF
#
# # 4. Install Redis
# sudo apt install -y redis-server
# sudo systemctl start redis
# sudo systemctl enable redis
#
# # 5. Install Node.js
# curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
# sudo apt install -y nodejs
#
# # 6. Install PM2
# sudo npm install -g pm2
#
# # 7. Clone and setup app
# cd /opt
# git clone <your-repo> bharatmart
# cd bharatmart
# npm install
# npm run build
#
# # 8. Copy this config
# cp config/samples/single-vm-local-stack.env .env
# nano .env  # Edit configuration
#
# # 9. Run migrations
# npm run migrate
#
# # 10. Start services
# pm2 start dist/server/index.js --name bharatmart-api
# pm2 start dist/server/workers/index.js --name bharatmart-worker
# pm2 save
# pm2 startup
#
# # 11. Setup Nginx (optional, for SSL)
# sudo apt install -y nginx certbot python3-certbot-nginx
# # Configure nginx.conf (see deployment/nginx.conf)
# sudo certbot --nginx -d yourdomain.com
#
# # 12. Setup automated backups
# crontab -e
# # Add: 0 2 * * * /opt/bharatmart/scripts/backup.sh
